name: Telegram Notifications

on:
  push:
  pull_request:
    types: [opened, closed, reopened]
  release:
    types: [published]
  create:
  delete:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare notification message
        id: prepare_message
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
          EVENT_TYPE="${{ github.event_name }}"
          MESSAGE=""

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° PUSH ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
          if [ "$EVENT_TYPE" = "push" ]; then
            if [ -z "${{ github.event.head_commit.id }}" ]; then
              BRANCH_REF=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
              MESSAGE="ðŸ—‘ï¸ Ð’ÐµÑ‚ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð°: $BRANCH_REF"
            else
              MESSAGE="ðŸ“Œ ÐÐ¾Ð²Ñ‹Ð¹ push Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹\nðŸ“‚ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: ${{ github.repository }}\nðŸŒ¿ Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: ${{ github.actor }}\nðŸ’¬ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.event.head_commit.message }}\nðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: ${{ github.event.head_commit.url }}"
            fi

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ‚ÐºÐ¸
          elif [ "$EVENT_TYPE" = "create" ]; then
            if [ "${{ github.ref_type }}" = "branch" ]; then
              MESSAGE="ðŸŒ¿ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð½Ð¾Ð²Ð°Ñ Ð²ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}"
            elif [ "${{ github.ref_type }}" = "tag" ]; then
              MESSAGE="ðŸ·ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚ÐµÐ³: ${{ github.ref_name }}"
            fi

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð²ÐµÑ‚ÐºÐ¸
          elif [ "$EVENT_TYPE" = "delete" ]; then
            if [ "${{ github.ref_type }}" = "branch" ]; then
              MESSAGE="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ð° Ð²ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}"
            elif [ "${{ github.ref_type }}" = "tag" ]; then
              MESSAGE="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½ Ñ‚ÐµÐ³: ${{ github.ref_name }}"
            fi

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° PULL REQUEST
          elif [ "$EVENT_TYPE" = "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            
            if [ "$ACTION" = "opened" ]; then
              MESSAGE="ðŸ†• ÐÐ¾Ð²Ñ‹Ð¹ Pull Request: $PR_TITLE\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $PR_AUTHOR\nðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: $PR_URL"
            elif [ "$ACTION" = "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                MESSAGE="âœ… Pull Request Ð¿Ñ€Ð¸Ð½ÑÑ‚: $PR_TITLE\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $PR_AUTHOR\nðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: $PR_URL"
              else
                MESSAGE="âŒ Pull Request Ð·Ð°ÐºÑ€Ñ‹Ñ‚: $PR_TITLE\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $PR_AUTHOR\nðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: $PR_URL"
              fi
            elif [ "$ACTION" = "reopened" ]; then
              MESSAGE="ðŸ”„ Pull Request reopened: $PR_TITLE\nðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $PR_AUTHOR\nðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: $PR_URL"
            fi

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° RELEASE
          elif [ "$EVENT_TYPE" = "release" ]; then
            MESSAGE="ðŸŽ‰ ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð·: ${{ github.event.release.name }}\nðŸ·ï¸ Ð’ÐµÑ€ÑÐ¸Ñ: ${{ github.event.release.tag_name }}\nðŸ“ ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: ${{ github.event.release.body }}\nðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: ${{ github.event.release.html_url }}"

          else
            MESSAGE="â„¹ï¸ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ: $EVENT_TYPE"
          fi

          # Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
          MESSAGE="${MESSAGE//'%'/'%25'}"
          MESSAGE="${MESSAGE//$'\n'/'%0A'}"
          MESSAGE="${MESSAGE//$'\r'/'%0D'}"
          
          # Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²Ñ‹Ð²Ð¾Ð´Ð°
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: ${{ steps.prepare_message.outputs.message }}
