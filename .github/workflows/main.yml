name: Telegram Notifications

on:
  push:
  pull_request:
    types: [opened, closed, reopened]
  release:
    types: [published]
  create: # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ Ð¸Ð»Ð¸ Ñ‚ÐµÐ³Ð°
  delete: # Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²ÐµÑ‚ÐºÐ¸ Ð¸Ð»Ð¸ Ñ‚ÐµÐ³Ð°

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare notification message
        id: prepare_message
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
          EVENT_TYPE="${{ github.event_name }}"

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° PUSH ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
          if [ "$EVENT_TYPE" = "push" ]; then
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð» Ð»Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð° Ð²ÐµÑ‚ÐºÐ° (ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð² Ð² push Ð½ÐµÑ‚)
            if [ -z "${{ github.event.head_commit.id }}" ]; then
              BRANCH_REF=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
              MESSAGE="ðŸ—‘ï¸ Ð’ÐµÑ‚ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð°: $BRANCH_REF"
            else
              # ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ push Ñ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°Ð¼Ð¸
              MESSAGE="ðŸ“Œ ÐÐ¾Ð²Ñ‹Ð¹ push Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
              ðŸ“‚ Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹: ${{ github.repository }}
              ðŸŒ¿ Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}
              ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: ${{ github.actor }}
              ðŸ’¬ ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.event.head_commit.message }}
              ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: ${{ github.event.head_commit.url }}"
            fi

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð²ÐµÑ‚ÐºÐ¸
          elif [ "$EVENT_TYPE" = "create" ]; then
            if [ "${{ github.ref_type }}" = "branch" ]; then
              MESSAGE="ðŸŒ¿ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð½Ð¾Ð²Ð°Ñ Ð²ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}"
            elif [ "${{ github.ref_type }}" = "tag" ]; then
              MESSAGE="ðŸ·ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚ÐµÐ³: ${{ github.ref_name }}"
            fi

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð²ÐµÑ‚ÐºÐ¸
          elif [ "$EVENT_TYPE" = "delete" ]; then
            if [ "${{ github.ref_type }}" = "branch" ]; then
              MESSAGE="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½Ð° Ð²ÐµÑ‚ÐºÐ°: ${{ github.ref_name }}"
            elif [ "${{ github.ref_type }}" = "tag" ]; then
              MESSAGE="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÐµÐ½ Ñ‚ÐµÐ³: ${{ github.ref_name }}"
            fi

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° PULL REQUEST
          elif [ "$EVENT_TYPE" = "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            
            case $ACTION in
              "opened")
                MESSAGE="ðŸ†• ÐÐ¾Ð²Ñ‹Ð¹ Pull Request: $PR_TITLE
                ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $PR_AUTHOR
                ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: $PR_URL" ;;
              "closed")
                if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                  MESSAGE="âœ… Pull Request Ð¿Ñ€Ð¸Ð½ÑÑ‚: $PR_TITLE
                  ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $PR_AUTHOR
                  ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: $PR_URL"
                else
                  MESSAGE="âŒ Pull Request Ð·Ð°ÐºÑ€Ñ‹Ñ‚: $PR_TITLE
                  ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $PR_AUTHOR
                  ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: $PR_URL"
                fi ;;
              "reopened")
                MESSAGE="ðŸ”„ Pull Request reopened: $PR_TITLE
                ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€: $PR_AUTHOR
                ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: $PR_URL" ;;
            esac

          # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° RELEASE
          elif [ "$EVENT_TYPE" = "release" ]; then
            MESSAGE="ðŸŽ‰ ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð·: ${{ github.event.release.name }}
            ðŸ·ï¸ Ð’ÐµÑ€ÑÐ¸Ñ: ${{ github.event.release.tag_name }}
            ðŸ“ ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ: ${{ github.event.release.body }}
            ðŸ”— Ð¡ÑÑ‹Ð»ÐºÐ°: ${{ github.event.release.html_url }}"

          else
            MESSAGE="â„¹ï¸ Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ: $EVENT_TYPE"
          fi

          # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð»Ð¸ÑˆÐ½Ð¸Ðµ Ð¾Ñ‚ÑÑ‚ÑƒÐ¿Ñ‹ Ð² Ð¼Ð½Ð¾Ð³Ð¾ÑÑ‚Ñ€Ð¾Ñ‡Ð½Ð¾Ð¼ Ñ‚ÐµÐºÑÑ‚Ðµ
          MESSAGE=$(echo "$MESSAGE" | sed 's/^[ \t]*//')
          
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ output Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼ ÑˆÐ°Ð³Ðµ
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: ${{ steps.prepare_message.outputs.message }}
